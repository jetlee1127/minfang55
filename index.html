<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>可可冒險島 Discord 指南模擬</title>
    <style>
        /* --- CSS 樣式 --- */
        :root {
            --discord-bg-darkest: #202225;
            --discord-bg-dark: #2f3136;
            --discord-bg-medium: #36393f;
            --discord-bg-light: #40444b;
            --discord-header: #202225;
            --discord-text-primary: #dcddde;
            --discord-text-secondary: #b9bbbe;
            --discord-text-muted: #72767d;
            --discord-text-link: #0096cf;
            --discord-channel-text: #b9bbbe;
            --discord-channel-hover-bg: #3a3c43;
            --discord-active-channel-bg: var(--discord-bg-light);
            --discord-mention-bg: rgba(88, 101, 242, 0.3);
            --discord-scrollbar-thumb: var(--discord-bg-darkest);
            --discord-scrollbar-track: var(--discord-bg-dark);
            --highlight-green: #43b581;
            --accent-color1: #d4a373;
            --panel-transition: width 0.3s ease-in-out;
        }

        body {
            font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            line-height: 1.7; margin: 0; background-color: var(--discord-bg-darkest);
            color: var(--discord-text-primary); display: flex; height: 100vh;
            overflow: hidden; font-size: 16px;
        }

        .discord-app-layout { display: flex; width: 100%; height: 100%; }
        .server-list {
            width: 72px; background-color: var(--discord-bg-darkest); padding: 12px 0;
            display: flex; flex-direction: column; align-items: center; flex-shrink: 0;
        }
        .server-icon {
            width: 48px; height: 48px; background-color: var(--discord-bg-light);
            border-radius: 50%; margin-bottom: 8px; display: flex; align-items: center;
            justify-content: center; font-size: 1.8em; color: var(--discord-text-primary);
            cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: border-radius 0.15s ease-out, background-color 0.15s ease-out;
        }
        .server-icon:hover { border-radius: 16px; background-color: var(--accent-color1); }
        .server-icon.active { border-radius: 16px; background-color: var(--accent-color1); }

        /* --- 頻道面板 (可收合) --- */
        .channels-panel {
            width: 280px;
            background-color: var(--discord-bg-dark); display: flex;
            flex-direction: column; flex-shrink: 0;
            transition: var(--panel-transition);
            position: relative;
            overflow: hidden;
        }
        .channels-panel.collapsed {
            width: 60px;
        }

        .server-name-header {
            height: 50px; padding: 0 10px 0 16px; display: flex; align-items: center;
            justify-content: space-between;
            font-weight: 600; font-size: 18px; color: var(--discord-text-primary);
            border-bottom: 1px solid var(--discord-bg-darkest);
            box-shadow: 0 1px 0 rgba(0,0,0,0.2), 0 1.5px 0 rgba(0,0,0,0.05), 0 2px 0 rgba(0,0,0,0.05);
            flex-shrink: 0;
            overflow: hidden;
        }
        .server-name-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            margin-right: 5px;
            display: inline-block; /* 確保 display 不是 none 以便 transition */
            opacity: 1;
            transition: opacity 0.2s ease-out, max-width 0.25s ease-in-out; /* 移除 width transition，避免影響 flex */
            max-width: calc(100% - 45px); /* 減去按鈕寬度和一些間距 */
        }
        .channels-panel.collapsed .server-name-text {
            opacity: 0;
            max-width: 0; /* 隱藏文字 */
            pointer-events: none;
            /* display: none; 會導致 transition 失效, 用 opacity 和 max-width 控制 */
        }
        .panel-toggle-button {
            background: none; border: none; color: var(--discord-text-muted);
            font-size: 1.6em; cursor: pointer; padding: 5px;
            line-height: 1; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            width: 40px; height: 40px;
            transition: color 0.2s;
        }
        .panel-toggle-button:hover { color: var(--discord-text-primary); }
        .channels-panel.collapsed .server-name-header {
             justify-content: center;
        }
         .channels-panel.brio-view .panel-toggle-button { /* 當處於brio視圖時，也允許收合按鈕 */
            /* display: none; */ /* 取消之前的隱藏，讓其與 guide 視圖行為一致 */
        }
        .channels-panel.brio-view .server-name-text {
            /* 如果希望在布里歐視圖下，即使面板展開，標題也隱藏，可以保留 display:none */
            /* 但為了統一收合體驗，這裡讓它和 guide 視圖一樣受 collapsed class 控制 */
        }


        .channel-list-container {
            padding: 18px 10px 18px 18px; overflow-y: auto; flex-grow: 1;
            scrollbar-width: thin; scrollbar-color: var(--discord-scrollbar-thumb) var(--discord-scrollbar-track);
            transition: opacity 0.2s ease-out 0.1s, visibility 0s linear 0.3s; /* 延遲一點再 hidden */
            opacity: 1;
            visibility: visible;
        }
        .channels-panel.collapsed .channel-list-container {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            height: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow: hidden !important;
        }
        /* 其他 CSS (channel-category-header, channel-item 等) 保持不變 */
        .channel-category-header { padding: 15px 0 10px 0; font-size: 1.05em; font-weight: 700; color: var(--discord-text-primary); text-transform: uppercase; border-bottom: 1px solid var(--discord-bg-light); margin-bottom: 10px; display: flex; align-items: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .channel-category-header .category-icon { font-size: 1.25em; margin-right: 8px; color: var(--accent-color1); }
        .channel-item { display: flex; align-items: center; padding: 7px 10px; border-radius: 4px; color: var(--discord-channel-text); font-weight: 500; font-size: 0.98em; cursor: pointer; margin-bottom: 2px; transition: background-color 0.15s ease-out, color 0.15s ease-out; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .channel-item:hover { background-color: var(--discord-channel-hover-bg); color: var(--discord-text-primary); }
        .channel-item.active { background-color: var(--discord-active-channel-bg); color: var(--discord-text-primary); font-weight: bold; }
        .channel-item.completed .channel-name-text:after { content: " ✔️"; color: var(--highlight-green); font-size: 0.9em; margin-left: 5px; }
        .channel-icon { margin-right: 8px; color: var(--discord-text-muted); min-width: 18px; font-size: 1em; }

        /* --- 主內容區樣式 --- */
        .main-content-area { flex-grow: 1; background-color: var(--discord-bg-medium); display: flex; flex-direction: column; overflow: hidden; height: 100vh; /* 強制高度 */ }
        .content-header { height: 50px; padding: 0 18px; display: flex; align-items: center; font-size: 17px; font-weight: 600; border-bottom: 1px solid var(--discord-bg-darkest); box-shadow: 0 1px 0 rgba(0,0,0,0.2); flex-shrink: 0; }
        .content-header .header-icon-placeholder { margin-right: 10px; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px; font-size: 1.2em; }
        .content-header .header-icon-placeholder .channel-icon { font-size: 1.3em; opacity: 0.8; }
        .content-header .dm-avatar-header { width: 30px; height: 30px; background-color: var(--accent-color1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1em; color: white; }
        .content-body { padding: 25px 30px; overflow-y: auto; flex-grow: 1; scrollbar-width: thin; scrollbar-color: var(--discord-scrollbar-thumb) var(--discord-scrollbar-track); font-size: 1em; line-height: 1.8; }
        .content-section { margin-bottom: 25px; padding: 20px; background-color: var(--discord-bg-dark); border-radius: 5px; }
        .content-section h3 { color: var(--discord-text-primary); font-size: 1.4em; margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid var(--discord-bg-light); padding-bottom: 10px; }
        .content-section h3.channel-title, .content-section h4.channel-title { font-size: 1.3em; font-weight: 500; color: var(--discord-text-primary); margin-top: 20px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: none; }
        .content-section h3.channel-title:first-child, .content-section h4.channel-title:first-child { margin-top: 0; }
        .content-section h3.channel-title:before, .content-section h4.channel-title:before { content: "# "; color: var(--discord-text-muted); font-weight: bold; margin-right: 4px; }
        .content-section p, .content-section li { color: var(--discord-text-secondary); margin-bottom: 10px; font-size: 1.05em; }
        .content-section ul, .content-section ol { padding-left: 30px; }
        .content-section strong.highlight { color: var(--accent-color1); font-weight: bold; }
        .content-section .important-note { color: #faa61a; font-weight: bold; }
        .content-section .architect-warning { display: block; margin-top: 10px; color: #faa61a; font-weight: bold; }
        .message-group { margin-bottom: 18px; }
        .message { display: flex; align-items: flex-start; padding: 2px 0; }
        .message-avatar { width: 42px; height: 42px; margin-right: 18px; font-size: 1.1em; border-radius: 50%; background-color: var(--accent-color1); flex-shrink: 0; display:flex; align-items:center; justify-content:center; font-weight:bold; color:white; }
        .message-avatar.kua { background-color: #7289da; }
        .message-content { flex-grow: 1; }
        .message-header { display: flex; align-items: baseline; margin-bottom: 4px; }
        .message-username { font-weight: 500; color: var(--discord-text-primary); margin-right: 8px; font-size: 1.05em;}
        .message-username.kua { color: #9099dd; }
        .message-timestamp { font-size: 0.8em; color: var(--discord-text-muted); }
        .message-text { color: var(--discord-text-primary); line-height: 1.45rem; font-size:1.05em;}
        .message-text p { margin-bottom: 5px !important; }
        .completion-toast { display: none; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background-color: var(--highlight-green); color: white; padding: 15px 25px; border-radius: 8px; z-index: 2000; font-size: 1.1em; box-shadow: 0 4px 10px rgba(0,0,0,0.2); animation: slideUpFadeOut 3.5s forwards; }
        @keyframes slideUpFadeOut { 0% { bottom: -60px; opacity: 0; } 15% { bottom: 30px; opacity: 1; } 85% { bottom: 30px; opacity: 1; } 100% { bottom: -60px; opacity: 0; } }
        @media (max-width: 768px) { body { font-size: 14px; } .channels-panel:not(.collapsed) { width: 220px; } .channels-panel.collapsed { width: 50px; } .server-name-header { font-size: 16px; padding: 0 8px 0 12px;} .panel-toggle-button { font-size: 1.4em; padding: 5px;} .channels-panel.collapsed .server-name-header { justify-content: center; } .content-header {font-size: 15px; padding: 0 12px;} .content-body {padding: 15px 20px;} }

    </style>
</head>
<body>

    <div class="discord-app-layout">
        <div id="serverList" class="server-list"></div>
        <div id="channelsPanelEl" class="channels-panel">
            <div class="server-name-header">
                <span id="serverNameTextEl">可可冒險島指南</span>
                <button id="panelToggleButtonEl" class="panel-toggle-button">«</button>
            </div>
            <div id="channelList" class="channel-list-container"></div>
        </div>
        <div class="main-content-area">
            <div id="contentHeader" class="content-header">
                <span class="header-icon-placeholder"><span class="channel-icon">#</span></span>
                <span id="currentChannelName"></span>
            </div>
            <div id="contentBody" class="content-body"></div>
        </div>
    </div>
    <div id="completionToast" class="completion-toast"></div>

    <script>
        // --- JavaScript 腳本 ---
        const servers = [
            { id: 'guide', name: '可可冒險島指南', icon: '🏝️', type: 'guide' },
            { id: 'brio', name: '與布里歐的對話', icon: '👨‍🍳', type: 'dialogue' }
        ];

        const guideTopics = [
            // ... (所有 guideTopics 的數據，確保文本無誤，#號標題已修正，簡體字已修正) ...
            // 例如，確保 island_facilities_others 的 content 中 architect-warning 是正確的
            {
                id: 'welcome', category: '歡迎來到可可冒險島', categoryIcon: '👋', icon: '#', name: '開始探索之旅',
                content: `...`, isCompleted: false
            },
            {
                id: 'discord_connection', category: '第壹章：Discord 系統', categoryIcon: '🖥️', icon: '#', name: 'Discord 連接與操作教學',
                content: `...`, isCompleted: false
            },
            {
                id: 'island_facilities_worldtree', category: '第貳章：可可冒險島', categoryIcon: '🏝️', icon: '#', name: '世界樹設施',
                content: `...`, isCompleted: false
            },
            {
                id: 'island_facilities_others', category: '第貳章：可可冒險島', icon: '#', name: '其他重要設施',
                content: `
                    <div class="content-section">
                        <h3 class="channel-title">可可冒險島事務中心</h3>
                        <ul>
                            <li><strong>許願池:</strong> 用來許願，不定時會有抽獎 (若沒有經費它就是個池塘 😉)。</li>
                            <li><strong>能量統計:</strong> 在營隊期間，會用來關心大家的餐食狀態。</li>
                        </ul>
                    </div>
                    <div class="content-section">
                        <h3 class="channel-title">甜點嘰嘰喳喳</h3>
                        <p>自由交談的空間，有許多文字聊天室 (#) 和語音聊天室 (🔊)。有些冠有特定股名稱的房間，則只有該股的成員才能看到和進入。</p>
                    </div>
                     <div class="content-section">
                        <h3 class="channel-title">調查員聚集地 & 小甜點聚落</h3>
                        <p>系統精靈：「這是你和管理員之間的<strong class="highlight">秘密通訊頻道</strong>！」</p>
                        <ul>
                            <li><strong>隱私第一:</strong> <strong class="highlight">只有你自己能看到和進入</strong>專屬空間。需身份認證開通。</li>
                            <li><strong>重要訊息:</strong> 空間內有三則重要訊息 (包含<strong class="highlight">小甜點夥伴</strong>及匿名聊天連結)。</li>
                            <li><span class="important-note">絕對保密事項:</span> Discord 中<strong class="highlight">黑色背景標示</strong>的內容 (匿名烘焙坊號碼(Line)、預設小甜點名、您的小甜點) <strong class="highlight">嚴禁外洩</strong>！</li>
                            <li><strong>員工機器人 & 商品:</strong> 可使用員工2指令購物 (需先加值)。<p class="architect-warning important-note">給甜點建築師的提醒: 使用「送禮物」功能時，對方會直接收到通知，所以請不要用這個功能來給你負責的小甜點送禮哦！</p></li>
                        </ul>
                    </div>
                `,
                isCompleted: false
            },
            {
                id: 'island_covenant', category: '第參章：可可冒險島約定', categoryIcon: '📜', icon: '#', name: '約定核心精神與條款',
                content: `...`, isCompleted: false
            },
            {
                id: 'island_notes_detail', category: '附註：可可冒險島須知', categoryIcon: '📌', icon: '#', name: '可可冒險島須知 (黃金守則)',
                content: `...`, isCompleted: false
            },
            {
                id: 'manager_words', category: '最終章：島嶼的溫度與祝福', categoryIcon: '💖', icon: '#', name: '管理員的祝福與期盼',
                content: `...`, isCompleted: false
            }
        ];
         // !! 請將上面省略的 guideTopics 的 content 從您之前正確的版本複製過來 !!

        const brioDialogueContent = { /* (brioDialogueContent 數據保持正確) */
            id: 'brio_main_dialogue',
            name: '與布里歐的記事記錄',
            icon: '👨‍🍳',
            content: `
                <div class="message-group">
                    <div class="message">
                        <div class="message-avatar">布</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-username">布里歐</span>
                                <span class="message-timestamp">可可曆 某年某月某日 - 關於《青春》</span>
                            </div>
                            <div class="message-text">
                                <p>「歲月悠悠，衰微只及肌膚，熱忱拋卻，頹廢必至靈魂。」<br>——塞繆爾·厄爾曼《青春》</p>
                                <p>垮垮垮鬆，是這就是再說你，不只皮膚鬆鬆的，還頹廢到了靈魂。</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="message-group">
                    <div class="message">
                        <div class="message-avatar kua">垮</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-username kua">垮垮垮鬆</span>
                                <span class="message-timestamp">片刻之後</span>
                            </div>
                            <div class="message-text">
                                <p>在啦，幹。</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="message-group">
                    <div class="message">
                        <div class="message-avatar">布</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-username">布里歐</span>
                                <span class="message-timestamp">可可曆 另一年某月某日 - 關於《看不見的城市》</span>
                            </div>
                            <div class="message-text">
                                <p>「生靈的地獄，不是一個即將來臨的地方；如果真有一個地獄，它已經就在這兒存在了，那是我們每天生活其間的地獄，是我們聚在一起而形成的地獄。」<br>——卡爾維諾《看不見的城市》</p>
                                <p>你能夠想像一堆甜點聚在一起嗎？那簡直是個天堂。</p>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="message-group">
                    <div class="message">
                        <div class="message-avatar">布</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-username">布里歐</span>
                                <span class="message-timestamp">可可曆 近期 - 關於奶龍</span>
                            </div>
                            <div class="message-text">
                                <p>奶龍就是沒有腮紅、耳朵及閃電形狀尾巴的皮卡丘。</p>
                                <p><em style="color:var(--discord-text-muted); font-size:0.9em;">(精靈画外音：這就是著名的奶龍傳說由來！XD)</em></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="content-section" style="background-color:var(--discord-bg-medium); border: 1px solid var(--discord-bg-light);">
                     <h3>關於布里歐的更多故事 (歷史片段)</h3>
                     <p>在可可曆127年，島上就有了這位傳奇的甜點建築師——布里歐 (Brio)。他不只是製作甜點，更是小甜點們的守護者。他用奶油般溫暖的雙手，為每個即將誕生的甜點灌注靈魂，輕聲對它們說：「歡迎來到世界，你準備好探索自己的甜美人生了嗎？」</p>
                     <p>布里歐深知每個甜點的獨特。他曾對焦慮的草莓泡芙說：「你不需要變得酥脆，柔軟也是一種可愛的特質。」他也鼓勵膽怯的可可可頌（也就是我們剛剛提到的『垮垮垮鬆』！）：『你經過層層折疊，才有了現在的樣子，不會這麼容易垮掉的。』他的信念是幫助甜點發掘自己的價值，而非改變它們。</p>
                </div>
            `,
            isCompleted: false
        };

        document.addEventListener('DOMContentLoaded', () => {
            const serverListEl = document.getElementById('serverList');
            const channelsPanelEl = document.getElementById('channelsPanelEl');
            const panelToggleButtonEl = document.getElementById('panelToggleButtonEl');
            const channelListEl = document.getElementById('channelList');
            const serverNameTextEl = document.getElementById('serverNameTextEl');
            const contentHeaderEl = document.getElementById('contentHeader');
            const currentChannelNameEl = document.getElementById('currentChannelName');
            const contentBodyEl = document.getElementById('contentBody');
            const completionToastEl = document.getElementById('completionToast');

            let activeServerId = 'guide';
            let activeChannelId = 'welcome';
            let isChannelPanelCollapsed = false;

            function toggleChannelsPanel() {
                isChannelPanelCollapsed = !isChannelPanelCollapsed;
                if (channelsPanelEl) {
                    channelsPanelEl.classList.toggle('collapsed', isChannelPanelCollapsed);
                }
                if (panelToggleButtonEl) {
                    panelToggleButtonEl.textContent = isChannelPanelCollapsed ? '☰' : '«';
                }
            }

            if(panelToggleButtonEl && channelsPanelEl) {
                panelToggleButtonEl.addEventListener('click', toggleChannelsPanel);
            }

            function renderServers() {
                if (!serverListEl) return;
                serverListEl.innerHTML = '';
                servers.forEach(server => {
                    const serverIconDiv = document.createElement('div');
                    serverIconDiv.classList.add('server-icon');
                    serverIconDiv.textContent = server.icon;
                    serverIconDiv.dataset.id = server.id;
                    if (server.id === activeServerId) {
                        serverIconDiv.classList.add('active');
                    }
                    serverIconDiv.addEventListener('click', () => selectServer(server.id));
                    serverListEl.appendChild(serverIconDiv);
                });
            }

            function renderChannelsOrDialogueTitle() {
                if (!channelListEl || !serverNameTextEl || !panelToggleButtonEl) return;
                channelListEl.innerHTML = '';
                const currentServer = servers.find(s => s.id === activeServerId);
                serverNameTextEl.textContent = currentServer ? currentServer.name : '未知區域';

                panelToggleButtonEl.style.display = 'flex'; // 默認顯示按鈕

                if (activeServerId === 'guide') {
                    let lastCategory = null;
                    guideTopics.forEach(topic => {
                        if (topic.category && topic.category !== lastCategory) {
                            const categoryDiv = document.createElement('div');
                            categoryDiv.classList.add('channel-category-header');
                            categoryDiv.innerHTML = `<span class="category-icon">${topic.categoryIcon || ''}</span>${topic.category}`;
                            channelListEl.appendChild(categoryDiv);
                            lastCategory = topic.category;
                        }

                        const channelDiv = document.createElement('div');
                        channelDiv.classList.add('channel-item');
                        channelDiv.dataset.id = topic.id;
                        if (topic.id === activeChannelId) {
                            channelDiv.classList.add('active');
                        }
                        const channelNameSpan = document.createElement('span');
                        channelNameSpan.classList.add('channel-name-text');
                        channelNameSpan.textContent = topic.name;

                        channelDiv.innerHTML = `<span class="channel-icon">${topic.icon || '#'}</span>`;
                        channelDiv.appendChild(channelNameSpan);

                        if (topic.isCompleted) {
                            channelDiv.classList.add('completed');
                        }

                        channelDiv.addEventListener('click', () => selectContentItem(topic.id, 'topic'));
                        channelListEl.appendChild(channelDiv);
                    });
                } else if (activeServerId === 'brio') {
                    // 布里歐視圖下，頻道列表只顯示一個總標題，收合按鈕仍然可用
                    const brioTitle = document.createElement('div');
                    brioTitle.classList.add('channel-category-header');
                    brioTitle.innerHTML = `<span class="category-icon">${brioDialogueContent.icon || '💬'}</span>${brioDialogueContent.name}`;
                    channelListEl.appendChild(brioTitle);
                }
            }

            function selectServer(serverId) {
                if (!servers.find(s => s.id === serverId)) return;
                activeServerId = serverId;

                // 切換伺服器時，保持用戶對頻道面板的收合偏好
                // (除非有特定邏輯要求在切換到某伺服器時強制展開/收合)
                if (channelsPanelEl) {
                     channelsPanelEl.classList.toggle('collapsed', isChannelPanelCollapsed);
                }
                if (panelToggleButtonEl) {
                     panelToggleButtonEl.textContent = isChannelPanelCollapsed ? '☰' : '«';
                }


                renderServers();

                if (activeServerId === 'guide') {
                    activeChannelId = guideTopics[0] ? guideTopics[0].id : 'welcome';
                    selectContentItem(activeChannelId, 'topic');
                } else if (activeServerId === 'brio') {
                    activeChannelId = brioDialogueContent.id;
                    selectContentItem(activeChannelId, 'dialogue');
                }
                renderChannelsOrDialogueTitle(); // 更新中間面板和收合按鈕狀態
            }

            function selectContentItem(itemId, type) {
                // ... (與之前相同) ...
                 activeChannelId = itemId;
                let selectedItem;
                let headerIconHtml = '<span class="channel-icon">#</span>';

                if (type === 'topic') {
                    selectedItem = guideTopics.find(t => t.id === itemId);
                    if(selectedItem) headerIconHtml = `<span class="channel-icon">${selectedItem.icon || '#'}</span>`;
                } else if (type === 'dialogue') {
                    selectedItem = brioDialogueContent;
                    if(selectedItem) headerIconHtml = `<div class="dm-avatar-header">${selectedItem.icon || selectedItem.name.charAt(0)}</div>`;
                }

                if (selectedItem && contentHeaderEl && currentChannelNameEl && contentBodyEl) {
                    let headerIconPlaceholder = contentHeaderEl.querySelector('.header-icon-placeholder');
                    if (!headerIconPlaceholder) {
                        headerIconPlaceholder = document.createElement('span');
                        headerIconPlaceholder.classList.add('header-icon-placeholder');
                        contentHeaderEl.insertBefore(headerIconPlaceholder, currentChannelNameEl);
                    }
                    headerIconPlaceholder.innerHTML = headerIconHtml;
                    currentChannelNameEl.textContent = (type === 'topic' && selectedItem) ? selectedItem.name : (selectedItem ? selectedItem.name : '未知內容');


                    contentBodyEl.innerHTML = selectedItem.content;
                    contentBodyEl.scrollTop = 0;

                    if (!selectedItem.isCompleted) {
                        selectedItem.isCompleted = true;
                        checkAllCompleted();
                    }
                    renderChannelsOrDialogueTitle();
                }
            }

            function checkAllCompleted() {
                // ... (與之前相同) ...
                const allTopicsDone = guideTopics.every(topic => topic.isCompleted);
                const brioDone = brioDialogueContent.isCompleted;
                if (allTopicsDone && brioDone && completionToastEl) {
                    if (completionToastEl.style.display !== 'block') {
                        completionToastEl.style.display = 'block';
                        completionToastEl.style.animation = 'none';
                        completionToastEl.offsetHeight; /* trigger reflow */
                        completionToastEl.style.animation = '';
                        setTimeout(() => {
                            completionToastEl.style.display = 'none';
                        }, 3500);
                    }
                }
            }

            // 初始化
            const initialElements = [
                serverListEl, channelsPanelEl, panelToggleButtonEl, channelListEl,
                serverNameTextEl, contentHeaderEl, contentBodyEl, completionToastEl
            ];
            if (initialElements.every(el => el)) {
                renderServers();
                selectServer(activeServerId);
            } else {
                console.error("一個或多個必要的 DOM 元素未找到，遊戲無法初始化。請檢查HTML中的ID。");
                 initialElements.forEach((el, index) => {
                    if (!el) console.error(`Element with expected ID '${['serverList', 'channelsPanelEl', 'panelToggleButtonEl', 'channelList', 'serverNameTextEl', 'contentHeader', 'contentBody', 'completionToast'][index]}' not found.`);
                });
            }
        });
    </script>
</body>
</html>
